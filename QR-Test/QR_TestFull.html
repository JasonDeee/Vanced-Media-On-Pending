<!DOCTYPE html>
<html>
  <head>
    <title>Donate Form</title>
    <style>
      /* CSS cho class "QRGenComplete" */
      .QRGenComplete {
        display: none; /* Ẩn theo mặc định */
      }

      /* CSS để hiển thị section khi có class "QRGenComplete" */
      .QRGenComplete.active {
        display: block; /* Hiển thị khi được thêm class "active" */
      }
    </style>
  </head>
  <body>
    <!-- Section "Mời Café" -->
    <section id="QR_ClientForm" class="active">
      <h2>Mời chúng tôi một ly cafe</h2>
      <label for="DonateName">Nickname - Để chúng mình có thể tri ân bạn</label
      ><br />
      <input type="text" id="DonateName" name="QRDonateName" /><br /><br />

      <label for="DonateMessage">Để lại lời nhắn tới Vanced</label><br />
      <textarea id="DonateMessage" name="QRDonateMessage"></textarea
      ><br /><br />

      <label for="DonatePrice">Số tiền ủng hộ:</label><br />
      <input
        type="text"
        id="DonatePrice"
        name="QRDonatePrice"
        value="321.000₫"
      /><br /><br />

      <button id="DonateButton">Tạo QR</button>
    </section>

    <!-- Section "Grazie" -->
    <section id="QR_Generated_Section" class="QRGenComplete">
      <h2>Grazie!</h2>
      <img id="QRImage" src="" alt="QR Code" />
      <button id="Cập nhật">Cập nhật</button>
      <button id="Quay lại">Quay lại</button>
    </section>

    <script>
      const donateButton = document.getElementById("DonateButton"); // Nút "Tạo QR"
      const updateButton = document.getElementById("Cập nhật"); // Nút "Cập nhật"
      const qrImage = document.getElementById("QRImage"); // Thay "QRImage" bằng ID của thẻ <img>
      const clientFormSection = document.getElementById("QR_ClientForm");
      const qrGeneratedSection = document.getElementById(
        "QR_Generated_Section"
      );

      // Dữ liệu QR code (ban đầu)
      let QRData = {
        accountNo: 1043374358,
        accountName: "VANCED",
        acqId: 970436,
        amount: 321000,
        addInfo: "HeheBoizz",
        format: "text",
        template: "qIRXByI",
      };

      // Hàm tạo QR code
      const generateQRCode = (qrData) => {
        return fetch("https://api.vietqr.io/v2/generate", {
          method: "POST",
          headers: {
            "x-client-id": "96a6c861-3012-4a20-aae1-da3955979482",
            "x-api-key": "984f47ea-7d4e-4255-858e-310c5622fb9d",
            "Content-Type": "application/json",
          },
          body: JSON.stringify(qrData),
        })
          .then((response) => response.json())
          .then((resData) => {
            // Trả về dữ liệu base64 của QR code
            console.log(resData.data.qrDataURL);

            return resData.data.qrDataURL;
          });
      };

      // Hàm xử lý khi bấm nút "Tạo QR" hoặc "Cập nhật"
      const handleGenerateOrUpdate = () => {
        // Lấy giá trị từ input
        let qrDonateName = document.getElementById("DonateName").value;
        let qrDonateMessage = document.getElementById("DonateMessage").value;
        let qrDonatePrice = document.getElementById("DonatePrice").value;

        // Tạo addInfo từ dữ liệu input
        let addInfo = `${qrDonateName} - ${qrDonateMessage} - ${qrDonatePrice}`;

        // Chuyển đổi format amount
        let amount = qrDonatePrice.replace(/\./g, "").replace("₫", "");

        // Cập nhật dữ liệu QR code
        QRData.addInfo = addInfo;
        QRData.amount = parseInt(amount, 10);

        // Tạo QR code
        generateQRCode(QRData)
          .then((qrCodeData) => {
            // Hiển thị QR code trực tiếp bằng dữ liệu base64
            qrImage.src = qrCodeData;

            // Gửi dữ liệu lên Google Sheets (chỉ khi bấm "Tạo QR")
            if (clientFormSection.classList.contains("active")) {
              return fetch(
                "https://script.google.com/macros/s/AKfycbxMaSr80UK7yGnCvWZtU1VIdyCHFTl3hc4bkQ59OHniUNYjk5tyvnOAEOHvCBedMgM9og/exec",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: JSON.stringify({
                    QRDonateName: qrDonateName,
                    QRDonateMessage: qrDonateMessage,
                    QRDonatePrice: qrDonatePrice,
                  }),
                }
              );
            }
          })
          .then((response) => {
            if (response) return response.text();
          })
          .then((spreadsheetData) => {
            if (spreadsheetData) console.log(spreadsheetData);
          })
          .catch((error) => {
            console.error("Lỗi:", error);
          })
          .finally(() => {
            // Chuyển đổi section (chỉ khi bấm "Tạo QR")
            if (clientFormSection.classList.contains("active")) {
              clientFormSection.classList.remove("active");
              clientFormSection.classList.add("QRGenComplete");
              qrGeneratedSection.classList.remove("QRGenComplete");
              qrGeneratedSection.classList.add("active");
            }
          });
      };

      // Gán sự kiện cho cả 2 nút
      donateButton.addEventListener("click", handleGenerateOrUpdate);
      updateButton.addEventListener("click", handleGenerateOrUpdate);

      // Xử lý nút "Quay lại"
      const backButton = document.getElementById("Quay lại");
      backButton.addEventListener("click", () => {
        // Hiển thị lại section "Mời Café"
        clientFormSection.classList.remove("QRGenComplete");
        clientFormSection.classList.add("active");

        // Ẩn section "Grazie"
        qrGeneratedSection.classList.remove("active");
        qrGeneratedSection.classList.add("QRGenComplete");
      });
    </script>
  </body>
</html>
