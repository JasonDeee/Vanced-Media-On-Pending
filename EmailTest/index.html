<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Email</title>
    <style>
      * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
      }
      body {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
      }
      label {
        font-size: 2rem;
      }
      input {
        width: 38vw;
        height: 64px;
        background: #e9e7e7;
        color: black;
        border: none;
        outline: none;
        border-radius: 8px;
        padding: 8px;
      }
      button {
        width: 15vw;
        height: 64px;
        font-size: 1.4rem;
        background: #151515;
        color: white;
        border: none;
        outline: none;
      }
    </style>
  </head>
  <body>
    <label for="EmailInput">Nhập Email</label>
    <input id="EmailInput" type="email" />
    <button id="submitBtn">Gửi</button>
    <p id="message" style="color: green"></p>
  </body>
  <script>
    // Khai báo các elements
    const emailInput = document.getElementById("EmailInput");
    const messageEl = document.getElementById("message");
    const submitBtn = document.getElementById("submitBtn");

    // Hàm validate email
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    submitBtn.addEventListener("click", function () {
      // Validate email
      if (!emailInput.value || !isValidEmail(emailInput.value)) {
        messageEl.style.color = "red";
        messageEl.textContent = "Vui lòng nhập email hợp lệ!";
        return;
      }

      // Disable nút submit
      submitBtn.disabled = true;
      messageEl.textContent = "Đang xử lý...";

      // Sử dụng google.script.run thay vì fetch
      google.script.run
        .withSuccessHandler(function (result) {
          messageEl.style.color = "green";
          messageEl.textContent = "Đăng ký thành công!";
          emailInput.value = "";

          // Disable form trong 5 giây
          setTimeout(() => {
            submitBtn.disabled = false;
          }, 5000);
        })
        .withFailureHandler(function (error) {
          messageEl.style.color = "red";
          messageEl.textContent = error.toString();
          submitBtn.disabled = false;
        })
        .processForm(emailInput.value);
    });

    // Debounce cho input
    let typingTimer;
    const doneTypingInterval = 1000;

    emailInput.addEventListener("input", function () {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        if (this.value && !isValidEmail(this.value)) {
          messageEl.style.color = "red";
          messageEl.textContent = "Email không hợp lệ";
        } else {
          messageEl.textContent = "";
        }
      }, doneTypingInterval);
    });
  </script>
  <!-- Cors Fix V2 -->
</html>
